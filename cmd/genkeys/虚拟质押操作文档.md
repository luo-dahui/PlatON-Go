
# 虚拟质押操作
- 背景

  由于虚拟节点为非真实节点，所以质押所需的nodeid, nodekey，blspubkey, blskey，blskey和对应的零知识证明以及版本签名必须使用工具提前生成，nodename等相关节点信息由运营提供；由于生成bls相关信息需要使用bls相关库，目前只有go有相关的库以及使用方法。

- 操作步骤主要包括：

  - 生成质押节点key信息：批量生成节点质押所需的nodeid, nodekey，blspubkey, blskey，blskey和对应的零知识证明以及版本签名保存到execl表格中；
  - 整合key和虚拟节点信息，用于批量质押；

  - 批量质押虚拟节点；

## 生成质押节点key信息

使用`genkeys`工具进行生成节点key信息，可通过源码编译方式获得`genkeys`工具，编译方法如下：

### 源码编译安装genkeys

- 支持Windows和Ubuntu下进行源码编译安装，根据自己的系统进行选择。

#### Windows源码编译

Windows编译环境需要符合以下条件：

- git：`2.19.1以上`
- go语言开发包：`go(1.11+)`
- mingw：`mingw（V8.1.0）`
- cmake: `3.0+`

可自行安装以上编译环境，在编译`genkeys`源码之前请确保以上环境可正常运行。

> 也可使用`Chocolatey`辅助安装编译环境（如果你还没有`chocolatey`，可以按照<https://chocolatey.org>上的说明进行安装），用管理员身份启动`PowerShell`，然后执行以下命令：
>
> 安装git：
>
> ```powershell
> choco install git
> ```
>
> 安装golang：
>
> ```powershell
> choco install golang
> ```
>
> 安装mingw：
>
> ```powershell
> choco install mingw
> ```
>
> 安装cmake：
>
> ```powershell
> choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System'
> ```
>
> 利用`chocolatey`包管理器安装的软件大部分有默认的安装路径，部分软件可能会有各种各样的路径，这取决于软件的发布者。安装这些包将修改Path环境变量。最后安装路径可查看PATH，某些机器环境可能在 PATH 中找不到这些工具的安装路径，此时需手动添加。安装完之后请确保已安装的Go版本为1.11（或更高版本）。
>

> 注意：以下命令均需在`Git-bash`环境运行， 在任意目录下，鼠标右键，选中`Git Bash Here`，弹出`Git Bash`运行窗口。

- 获取源码

获取源码放到GOPATH路径下，其中`feature/alaya-launching`为分支名称，届时切换到实际的分支：

```shell
mkdir -p $GOPATH/src/github.com/PlatONnetwork
cd $GOPATH/src/github.com/PlatONnetwork
git clone -b feature/alaya-launching https://github.com/luo-dahui/PlatON-Go.git --recursive
```

- 添加bls依赖库到环境变量

```bash
echo 'export PATH=$PATH:"$GOPATH/src/github.com/PlatONnetwork/PlatON-Go/crypto/bls/bls_win/lib"' >> ~/.bashrc
source ~/.bashrc
```

- 编译

```bash
cd $GOPATH/src/github.com/PlatONnetwork/PlatON-Go
go run build/ci.go install ./cmd/genkeys
```

编译完成之后在`PlatON-Go/build/bin`目录下会生成`genkeys.exe`可执行文件，将可执行文件拷贝到自己工作目录运行即可。

> 重复编译会覆盖之前生成的可执行文件。

#### Ubuntu源码编译

**step1.** 安装编译环境（Ubuntu）：

- 系统版本：`Ubuntu 18.04.1 及以上`
- git：`2.19.1及以上`
- 编译器：`gcc(4.9.2+)`、`g++(5.0+)`
- go语言开发包：`go(1.11+)`
- cmake:`3.0+`

**step2.** 获取源码：

```bash
git clone -b feature/alaya-launching https://github.com/luo-dahui/PlatON-Go.git --recursive
```

**step3.** 安装依赖库：

```bash
sudo apt update 
sudo apt install -y golang-go cmake llvm g++ libgmp-dev libssl-dev
```

**step4.** 编译：

```bash
cd PlatON-Go 
make all
```

编译完成之后在`./build/bin`目录下会生成`genkeys`等一系列可执行文件。

**step5.** 拷贝二进制： 

```shell
sudo cp -f ./build/bin/genkeys /usr/bin/
```

源码编译成功！



### 生成节点key信息

执行命令：

```shell
genkeys --count 10
```

> --count: 表示节点的个数；
>
> 客户端界面打印如：`生成虚拟节点信息成功, 生成文件路径: /home/ldh/key_info.xlsx`，表示生成节点key信息成功，并保存在`key_info.xlsx`文件中；